<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ArchMiniOS</title>
<style>
@font-face {
  font-family: 'IBMVGA8';
  src: url('https://cdn.jsdelivr.net/gh/iamdual/IBM_VGA8/IBMVGA8.woff2') format('woff2'),
       url('https://cdn.jsdelivr.net/gh/iamdual/IBM_VGA8/IBMVGA8.woff') format('woff');
  font-display: swap;
  unicode-range: U+0000-00FF, U+0400-04FF; /* ASCII, Cyrillic  */
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}
body {
  background: #000;
  color: #fff;
  width: 100vw;
  height: 100vh;
  min-height: 100vh;
  min-width: 100vw;
  overflow: hidden;
  font-family: 'IBMVGA8', monospace;
  font-size: 16px;
  box-sizing: border-box;
  letter-spacing: 0;
}

#terminal {
  position: fixed;
  left: 0; top: 0;
  width: 100vw;
  height: 100vh;
  background: transparent;
  padding: 24px 16px 0 16px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

#termOutput {
  flex: 1 1 0%;
  overflow-y: auto;
  overflow-x: hidden;
  white-space: pre-wrap;
  font-family: inherit;
  margin-bottom: 0.5em;
  width: 100%;
  outline: none;
}

.output-line {
  color: #fff;
  font-family: inherit;
  background: none;
  margin: 0 0 0.05em 0;
  line-height: 1.35;
  word-break: break-all;
}

.output-line.error {
  color: #f00;
}
.output-line.info {
  color: #fff;
  opacity: 1;
}
.output-line.success {
  color: #0f0;
}

#command-line-block {
  width: 100%;
  background: none;
  margin: 0;
  border: none;
  padding: 0;
}

.command-input-row {
  display: flex;
  align-items: center;
  width: 100%;
  background: none;
  margin: 0;
  padding: 0;
}

.command-prompt {
  color: #fff;
  font-family: inherit;
  margin-right: 8px;
  user-select: none;
  font-size: 1rem;
  font-weight: bold;
  letter-spacing: 0.3px;
}

#commandInput {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: #fff;
  font-size: 1rem;
  font-family: inherit;
  padding: 0;
  margin-left: 0;
  caret-color: #fff;
}

#commandInput:focus {
  outline: none;
  background: none;
}

::-webkit-scrollbar {
  width: 7px;
  background: #000;
}
::-webkit-scrollbar-thumb {
  background: #222;
  border-radius: 0px;
}

.animated-type {
  border-right: .14em solid #fff;
  animation: blink-caret 0.8s step-end infinite;
}

@keyframes blink-caret {
  from, to { border-color: transparent; }
  50% { border-color: #fff; }
}

/* Remove selection highlights */
::selection {
  background: #333;
  color: #fff;
}
</style>
</head>
<body>
<div id="terminal">
  <div id="termOutput">
    <div class="output-line info" style="opacity:.65;">Type <span style="color:#fff;">help</span> to see commands. Arrow Up/Down to recall!</div>
  </div>
  <div id="command-line-block">
    <div class="command-input-row">
      <span class="command-prompt">&gt;</span>
      <input type="text" id="commandInput" autocomplete="off" spellcheck="false" placeholder="" autofocus>
    </div>
  </div>
</div>
<script>
let commandHistory = [];
let historyIndex = -1;

const forkVersionString = " [fork v1.0]";

const translations = {
  en: {
    intro: 'Type <span style="color:#fff;">help</span> to see commands. Arrow Up/Down to recall! [fork v1.0]',
    exit: 'Exiting OS... [fork v1.0]',
    available: 'Available commands: [fork v1.0]',
    helpstr: 'help, exit, clear, ver, echo, opensite, time, background, showip, notepad, search, calc, random, creators, lang, settitle, color, taskmanager [fork v1.0]',
    version: 'laxminios-ooollama_ fork v1.0',
    echoEmpty: "Enter text after echo [fork v1.0]",
    opensite: "Opening site: ",
    opensiteHint: "Specify a URL! Example: opensite https://example.com [fork v1.0]",
    time: "Current time: ",
    backgroundChanged: "Background changed. [fork v1.0]",
    backgroundExample: "Example: background #23236a [fork v1.0]",
    ipLoading: "Loading IP... [fork v1.0]",
    ipDisplay: "Your IP: ",
    ipError: "Error obtaining IP. [fork v1.0]",
    notepadTitle: "Notepad [fork v1.0]",
    save: "Save",
    close: "Close",
    searchDoing: "Searching: ",
    searchHint: "Specify a keyword after search [fork v1.0]",
    calcErrorChar: "Invalid character [fork v1.0]",
    calcResult: "Result: ",
    calcError: "Error: ",
    calcHint: "Example: calc 2+2*8 [fork v1.0]",
    randomResult: "Random number: ",
    randomHint: "Example: random 1-100 [fork v1.0]",
    creators: "Fork by ooollama_ [fork v1.0]. Original: orange227, ChatGPT",
    tmNotAvailable: "taskmanager is not supported in minimal fork. [fork v1.0]",
    unknown: "Unknown command. Type help for list. [fork v1.0]",
    setlangSuccess: (lang) => `Language set to ${lang} [fork v1.0]`,
    setlangList: "Usage: lang en | ru [fork v1.0]",
    settitleSuccess: (title) => `Title set to \"${title}\" [fork v1.0]`,
    settitleHint: "Usage: settitle your-title-string [fork v1.0]",
    colorChanged: "Terminal text color changed. [fork v1.0]",
    colorHint: "Example: color #00ffff [fork v1.0]"
  },
  ru: {
    intro: 'Напишите <span style="color:#fff;">help</span>, чтобы увидеть команды. Вверх/Вниз — история! [fork v1.0]',
    exit: 'Выход из OS... [fork v1.0]',
    available: 'Доступные команды: [fork v1.0]',
    helpstr: 'help, exit, clear, ver, echo, opensite, time, background, showip, notepad, search, calc, random, creators, lang, settitle, color, taskmanager [fork v1.0]',
    version: 'laxminios-ooollama_ fork v1.0',
    echoEmpty: "Введите текст после echo [fork v1.0]",
    opensite: "Открывается сайт: ",
    opensiteHint: "Укажите ссылку! Пример: opensite https://example.com [fork v1.0]",
    time: "Текущее время: ",
    backgroundChanged: "Фон изменён. [fork v1.0]",
    backgroundExample: "Пример: background #23236a [fork v1.0]",
    ipLoading: "IP загружается... [fork v1.0]",
    ipDisplay: "Ваш IP: ",
    ipError: "Ошибка получения IP. [fork v1.0]",
    notepadTitle: "Блокнот [fork v1.0]",
    save: "Сохранить",
    close: "Закрыть",
    searchDoing: "Осуществляется поиск: ",
    searchHint: "Укажите ключевое слово после search [fork v1.0]",
    calcErrorChar: "Некорректный символ [fork v1.0]",
    calcResult: "Результат: ",
    calcError: "Ошибка: ",
    calcHint: "Пример: calc 2+2*8 [fork v1.0]",
    randomResult: "Случайное число: ",
    randomHint: "Пример: random 1-100 [fork v1.0]",
    creators: "Форк от ooollama_ [fork v1.0]. Оригинал: orange227, ChatGPT",
    tmNotAvailable: "taskmanager не поддерживается в минимал форке. [fork v1.0]",
    unknown: "Неизвестная команда. help — список. [fork v1.0]",
    setlangSuccess: (lang) => `Язык установлен на ${lang} [fork v1.0]`,
    setlangList: "Использование: lang en | ru [fork v1.0]",
    settitleSuccess: (title) => `Заголовок установлен на \"${title}\" [fork v1.0]`,
    settitleHint: "Использование: settitle ваш-заголовок [fork v1.0]",
    colorChanged: "Цвет текста терминала изменён. [fork v1.0]",
    colorHint: "Пример: color #00ffff [fork v1.0]"
  }
};
let currentLang = 'en';

function t(key, ...args) {
  const value = translations[currentLang][key];
  return typeof value === "function" ? value(...args) : value;
}

// Sanitize strings to prevent possible XSS if using innerHTML
function escapeHTML(str) {
  if (typeof str !== "string") return str;
  return str.replace(/[&<>"']/g, function (m) {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return m;
    }
  });
}

function setLang(lang) {
  if (!(lang in translations)) return false;
  currentLang = lang;
  document.documentElement.lang = lang;
  // Change intro text as well
  const output = document.getElementById("termOutput");
  if (output && output.firstElementChild && output.firstElementChild.classList.contains('info')) {
    output.firstElementChild.innerHTML = t('intro');
  }
  return true;
}

function addOutput(text, type = "normal") {
  // Always add [fork v1.0] to the end if not already present, EXCEPT for .intro line (already appended in translation)
  let finalText = text;
  if (
    type !== "info" ||
    text !== t('intro')
  ) {
    // If the text doesn't already include [fork v1.0] and is not a number result, append
    if (typeof finalText === "string" && !finalText.includes('[fork v1.0]') && !/^\s*-?\d+(\.\d+)?\s*$/.test(finalText)) {
      finalText += forkVersionString;
    }
  }
  const out = document.createElement('div');
  out.className = 'output-line' + (type && type !== "normal" ? " " + type : "");
  // For .info/typing, support innerHTML for intro only, else textContent for safety
  if (type === "info" && text === t('intro')) {
    out.innerHTML = text; // safe, as it's from translations only, not user input
  } else {
    out.textContent = finalText;
  }
  document.getElementById("termOutput").appendChild(out);
  out.scrollIntoView({ behavior: "smooth", block: "end" });
}

function addOutputTyping(text, type = "normal", speed = 10) {
  // Always add [fork v1.0] to the end if not already present
  let finalText = text;
  if (typeof finalText === "string" && !finalText.includes('[fork v1.0]')) {
    finalText += forkVersionString;
  }
  const out = document.createElement('div');
  out.className = 'output-line animated-type' + (type && type !== "normal" ? " " + type : "");
  document.getElementById("termOutput").appendChild(out);
  let i = 0;
  function typer() {
    out.textContent = finalText.slice(0, ++i);
    if (i < finalText.length) setTimeout(typer, speed);
    else out.classList.remove('animated-type');
  } typer();
}

function clearTermOutput() {
  document.getElementById("termOutput").innerHTML = '';
}

function scrollTermToBottom() {
  const term = document.getElementById("termOutput");
  if (term) term.scrollTop = term.scrollHeight + 300;
}

function initializeCommandLine() {
  const input = document.getElementById("commandInput");
  input.focus();
  // Remove previous event listeners
  input.onkeydown = null;
  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      const commandLine = this.value.trim();
      if (!commandLine) return;
      commandHistory.push(commandLine);
      historyIndex = commandHistory.length;
      addOutput("> " + commandLine, "info");
      handleCommand(commandLine);
      this.value = "";
      scrollTermToBottom();
      event.preventDefault();
    }
    else if (event.key === "ArrowUp") {
      event.preventDefault();
      if (commandHistory.length && historyIndex > 0) {
        historyIndex--;
        input.value = commandHistory[historyIndex];
      } else if (commandHistory.length && historyIndex <= 0) {
        historyIndex = 0;
        input.value = commandHistory[historyIndex];
      }
    } else if (event.key === "ArrowDown") {
      event.preventDefault();
      if (commandHistory.length && historyIndex < commandHistory.length - 1) {
        historyIndex++;
        input.value = commandHistory[historyIndex];
      } else if (historyIndex >= commandHistory.length - 1) {
        input.value = "";
        historyIndex = commandHistory.length;
      }
    }
  });
}

function isColor(str) {
  if (/^#[0-9a-f]{3,8}$/i.test(str)) return true;
  const basicColors = [
    "black", "white", "gray", "grey", "red", "green", "blue", "yellow", "aqua",
    "fuchsia", "lime", "maroon", "navy", "olive", "purple", "silver", "teal"
  ];
  return basicColors.indexOf(str.toLowerCase()) !== -1;
}

function isValidUrl(str) {
  try {
    let url = new URL(str);
    return url.protocol === 'http:' || url.protocol === 'https:';
  } catch (e) {
    return false;
  }
}

function handleCommand(commandLine) {
  const cmd = commandLine.split(" ")[0].toLowerCase();
  const argument = commandLine.substring(cmd.length).trim();

  switch (cmd) {
    case "exit":
      addOutputTyping(t("exit"), "info");
      setTimeout(() => window.location.href = "about:blank", 900);
      break;

    case "clear":
      clearTermOutput();
      addOutput("", "info"); // Show fork version after clear
      break;

    case "help":
      addOutput(t("available"), "info");
      addOutput(t("helpstr"), "success");
      break;

    case "ver":
      addOutput(t("version"), "success");
      break;

    case "echo":
      addOutput(argument ? escapeHTML(argument) : t("echoEmpty"), "info");
      break;

    case "opensite":
      if (argument) {
        if (isValidUrl(argument)) {
          addOutput(t("opensite") + escapeHTML(argument), "info");
          setTimeout(() => window.open(argument, "_blank"), 600);
        } else {
          addOutput(t("opensiteHint"), "error");
        }
      } else {
        addOutput(t("opensiteHint"), "error");
      }
      break;

    case "time":
      addOutput(t("time") + (new Date()).toLocaleTimeString(), "info");
      break;

    case "background":
      if (argument) {
        if (isColor(argument)) {
          document.body.style.background = argument;
          addOutput(t("backgroundChanged"), "success");
        } else {
          addOutput(t("backgroundExample"), "info");
        }
      } else {
        addOutput(t("backgroundExample"), "info");
      }
      break;

    case "showip":
      addOutput(t("ipLoading"), "info");
      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          if (data && data.ip) addOutput(t("ipDisplay") + data.ip, "success");
          else addOutput(t("ipError"), "error");
        })
        .catch(() => addOutput(t("ipError"), "error"));
      break;

    case "notepad": {
      if (document.getElementById("archnotepad-modal")) document.getElementById("archnotepad-modal").remove();
      const modal = document.createElement("div");
      modal.id = "archnotepad-modal";
      modal.style.cssText = `
        position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
        z-index:1000;background:#000;border:1.5px solid #fff;
        color:#fff;font-family:inherit;padding:16px 16px;min-width:340px;display:flex;flex-direction:column;gap:8px;
      `;
      modal.innerHTML = `
        <h2 style="margin:0 0 8px 0;font-size:1.07rem;font-weight:bold;color:#fff;font-family:'IBMVGA8',monospace;">${t('notepadTitle')}</h2>
        <textarea style="width:320px;max-width:90vw;height:90px;background:#000;border:1px solid #fff;color:#fff;padding:7px;font-family:'IBMVGA8',monospace;font-size:0.95rem;resize:vertical;" id="noteArea"></textarea>
        <div style="display:flex;justify-content:flex-end;gap:11px;">
          <button id="noteSaveBtn" style="background:#000;color:#fff;border:1.5px solid #fff;padding:2px 13px;font-family:'IBMVGA8',monospace;cursor:pointer;">${t('save')}</button>
          <button id="noteCloseBtn" style="background:#000;color:#fff;border:1.5px solid #fff;padding:2px 13px;font-family:'IBMVGA8',monospace;cursor:pointer;">${t('close')}</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById("noteArea").focus();
      modal.querySelector("#noteCloseBtn").onclick = () => modal.remove();
      modal.querySelector("#noteSaveBtn").onclick = () => {
        const txt = modal.querySelector("#noteArea").value;
        const blob = new Blob([txt], { type: "text/plain" });
        const a = document.createElement("a");
        a.download = "note.txt";
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          URL.revokeObjectURL(a.href);
          a.remove();
        }, 500);
      };
      modal.addEventListener('keydown', (e) => {
        if (e.key === "Escape") modal.remove();
      });
      break;
    }
    case "search":
      if (argument) {
        addOutput(t("searchDoing") + escapeHTML(argument), "info");
        window.open("https://www.google.com/search?q=" + encodeURIComponent(argument), "_blank");
      } else {
        addOutput(t("searchHint"), "error");
      }
      break;

    case "calc":
      if (argument) {
        try {
          if (/[^0-9+\-*/()., ]/.test(argument)) throw new Error(t("calcErrorChar"));
          const fn = Function('"use strict";return (' + argument.replace(",",".") + ')');
          const res = fn();
          if (typeof res !== "number" || isNaN(res)) throw new Error(t("calcError"));
          addOutput(t("calcResult") + res, "success");
        } catch (e) {
          addOutput(t("calcError") + (e.message || t("calcError")), "error");
        }
      } else {
        addOutput(t("calcHint"), "info");
      }
      break;

    case "random": {
        let [min, max] = argument.replace(/\s+/g, '').split("-");
        min = parseInt(min, 10);
        max = parseInt(max, 10);
        if (!isNaN(min) && !isNaN(max) && max >= min) {
          const rand = Math.floor(Math.random() * (max - min + 1)) + min;
          addOutput(t("randomResult") + rand, "success");
        } else {
          addOutput(t("randomHint"), "info");
        }
        break;
      }
    case "creators":
      addOutput(t("creators"), "success");
      break;

    case "taskmanager":
      addOutput(t("tmNotAvailable"), "error");
      break;

    case "lang":
      {
        if (argument === "en" || argument === "ru") {
          setLang(argument);
          addOutput(t("setlangSuccess", argument), "success");
        } else {
          addOutput(t("setlangList"), "info");
        }
        break;
      }
    case "settitle":
      {
        if (argument) {
          document.title = argument;
          addOutput(t("settitleSuccess", argument), "success");
        } else {
          addOutput(t("settitleHint"), "info");
        }
        break;
      }
    case "color":
      {
        if (argument && isColor(argument)) {
          document.body.style.color = argument;
          const all = document.querySelectorAll('.output-line,.command-prompt,#commandInput');
          all.forEach(e => e.style.color = argument);
          addOutput(t("colorChanged"), "success");
        } else if(argument) {
          addOutput(t("colorHint"), "info");
        } else {
          addOutput(t("colorHint"), "info");
        }
        break;
      }
    default:
      addOutput(t("unknown"), "error");
      break;
  }
}

document.addEventListener("DOMContentLoaded", function () {
  setLang(currentLang); // Set initial language and intro
  initializeCommandLine();
  document.getElementById("commandInput").focus();
  setTimeout(scrollTermToBottom, 100);
});

const terminalEl = document.getElementById("terminal");
if (terminalEl) {
  terminalEl.onmousedown = () => {
    setTimeout(() => {
      const inp = document.getElementById("commandInput");
      if (inp) inp.focus();
    }, 50);
  };
}
</script>
</body>
</html>
